// third-party dependencies
const Bluebird   = require('bluebird');

// h-deps
const HProjectClient   = require('h-project-client');
const HWorkspaceClient = require('h-workspace-client/public/authenticated');

// injected modules
const habemusEditorUrls = require('habemus-editor-urls');

const PERMISSION_SCOPES = [
  'admin',
  'read',
  'update',
  'delete'
];

module.exports = function (options) {

  var apiVersion = options.cloud.apiVersion;
  var hWorkspaceURI = options.cloud.hWorkspaceURI;

  var authToken = options.cloud.authToken;
  var projectCode = options.cloud.projectCode;

  if (!apiVersion) {
    throw new Error('cloud.apiVersion is required');
  }

  if (!hWorkspaceURI) {
    throw new Error('cloud.hWorkspaceURI is required');
  }

  if (!authToken) {
    throw new Error('cloud.authToken is required');
  }

  if (!projectCode) {
    throw new Error('cloud.projectCode is required');
  }
  
  /**
   * HWorkspace client.
   * Exposes the h-dev api through websockets that connect to the 
   * workspace server.
   * 
   * @type {HWorkspaceClient}
   */
  var hWorkspace = new HWorkspaceClient({
    apiVersion: apiVersion,
    serverURI: hWorkspaceURI,
  });

  return hWorkspace.get(
    authToken,
    projectCode,
    {
      byProjectCode: true
    }
  )
  .then(function (workspace) {
    /**
     * The root url for the project's preview
     * @type {String}
     */
    hWorkspace.projectRootURL =
      habemusEditorUrls.format.workspacePreview(projectCode);

    /**
     * Whenever the workspace's room is destroyed,
     * we should reload the editor so that a new room is set up.
     */
    hWorkspace.on('room-destroyed', function () {
      // refresh the webpage
      window.location.reload();
    });

    return hWorkspace.connect(authToken, projectCode);
  })
  .then(function () {
    // h-workspace exposes the hDev API
    return hWorkspace;
  });
}
