// third-party dependencies
const Bluebird   = require('bluebird');

const HDevAuthenticatedClient = require('h-dev-cloud/client/authenticated');

const PERMISSION_SCOPES = [
  'admin',
  'read',
  'update',
  'delete'
];

module.exports = function (options) {

  var apiVersion = options.cloud.apiVersion;
  var hDevCloudURI = options.cloud.hDevCloudURI;

  var authToken = options.cloud.authToken;
  var workspaceCode = options.cloud.workspaceCode;

  if (!apiVersion) {
    throw new Error('cloud.apiVersion is required');
  }

  if (!hDevCloudURI) {
    throw new Error('cloud.hDevCloudURI is required');
  }

  if (!authToken) {
    throw new Error('cloud.authToken is required');
  }

  if (!workspaceCode) {
    throw new Error('cloud.workspaceCode is required');
  }

  var hDev = new HDevAuthenticatedClient({
    apiVersion: apiVersion,
    serverURI: hDevCloudURI,
  });

  return hDev.getWorkspaceByCode(authToken, workspaceCode)
    // TODO: workspace creation logic MUST NOT be here
    // TODO: workspace creation logic MUST NOT be here
    // TODO: workspace creation logic MUST NOT be here
    .catch(function (err) {

      if (err.name === 'NotFound') {

        return hDev.createWorkspace(authToken, {
          projectCode: workspaceCode,
        });

      } else {
        return Bluebird.reject(err);
      }
    })
    // TODO: workspace creation logic MUST NOT be here
    // TODO: workspace creation logic MUST NOT be here
    .then(function (workspace) {
      hDev.projectRootURL = workspace.previewURL;
      return hDev.connect(authToken, workspaceCode);
    })
    .then(function () {
      return hDev;
    });
}
