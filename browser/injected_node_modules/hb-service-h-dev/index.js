// third-party dependencies
const Bluebird   = require('bluebird');

const HDevAuthenticatedClient = require('h-dev-cloud/client/authenticated');

const PERMISSION_SCOPES = [
  'admin',
  'read',
  'update',
  'delete'
];

module.exports = function (options) {

  var apiVersion = options.cloud.apiVersion;
  var hDevCloudURI = options.cloud.hDevCloudURI;

  var authToken = options.cloud.authToken;
  var projectCode = options.cloud.projectCode;

  if (!apiVersion) {
    throw new Error('cloud.apiVersion is required');
  }

  if (!hDevCloudURI) {
    throw new Error('cloud.hDevCloudURI is required');
  }

  if (!authToken) {
    throw new Error('cloud.authToken is required');
  }

  if (!projectCode) {
    throw new Error('cloud.projectCode is required');
  }

  var hDev = new HDevAuthenticatedClient({
    apiVersion: apiVersion,
    serverURI: hDevCloudURI,
  });

  return hDev.getWorkspaceByCode(authToken, projectCode)
    .catch(function (err) {

      if (err.name === 'NotFound') {

        return hDev.createWorkspace(authToken, {
          projectCode: projectCode,
        });

      } else {
        return Bluebird.reject(err);
      }
    })
    .then(function (workspace) {

      hDev.projectRootURL = workspace.previewURL;

      return hDev.connect(projectCode, authToken);
    })
    .then(function () {
      return hDev;
    });
}
