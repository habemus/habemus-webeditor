// third-party dependencies
const Bluebird   = require('bluebird');

const HProjectClient   = require('h-project-client');
const HWorkspaceClient = require('h-workspace-client/authenticated');

const PERMISSION_SCOPES = [
  'admin',
  'read',
  'update',
  'delete'
];

module.exports = function (options) {

  var apiVersion = options.cloud.apiVersion;
  var hWorkspaceURI = options.cloud.hWorkspaceURI;

  var authToken = options.cloud.authToken;
  var workspaceCode = options.cloud.workspaceCode;

  if (!apiVersion) {
    throw new Error('cloud.apiVersion is required');
  }

  if (!hWorkspaceURI) {
    throw new Error('cloud.hWorkspaceURI is required');
  }

  if (!authToken) {
    throw new Error('cloud.authToken is required');
  }

  if (!workspaceCode) {
    throw new Error('cloud.workspaceCode is required');
  }

  var hWorkspace = new HWorkspaceClient({
    apiVersion: apiVersion,
    serverURI: hWorkspaceURI,
  });

  return hWorkspace.get(
    authToken,
    workspaceCode,
    {
      byProjectCode: true
    }
  )
  .then(function (workspace) {
    hWorkspace.projectRootURL = workspace.previewURL;
    return hWorkspace.connect(authToken, workspaceCode);
  })
  .then(function () {
    // h-workspace exposes the hDev API
    return hWorkspace;
  });
}
