// third-party dependencies
const Bluebird   = require('bluebird');

const HDevCloudClient = require('h-dev-cloud/client');

const PERMISSION_SCOPES = [
  'admin',
  'read',
  'update',
  'delete'
];

module.exports = function (options) {

  var apiVersion = options.cloud.apiVersion;
  var hDevCloudURI = options.cloud.hDevCloudURI;

  var authToken = options.cloud.authToken;
  var projectCode = options.cloud.projectCode;

  if (!apiVersion) {
    throw new Error('cloud.apiVersion is required');
  }

  if (!hDevCloudURI) {
    throw new Error('cloud.hDevCloudURI is required');
  }

  if (!authToken) {
    throw new Error('cloud.authToken is required');
  }

  if (!projectCode) {
    throw new Error('cloud.projectCode is required');
  }

  var hdev = new HDevCloudClient({
    apiVersion: apiVersion,
    serverURI: hDevCloudURI,
  });

  // first ensure that the workspace
  // has been created and has its files loaded into place
  return hdev.ensureWorkspaceExists(authToken, projectCode)
    .then(function () {
      return hdev.connect(authToken, projectCode, PERMISSION_SCOPES)
    })
    .then(function () {
      return hdev;
    });
}
