// third-party
const Bluebird = require('bluebird');

module.exports = function (habemus, options) {

  const hAccountDialog = habemus.services.hAccountDialog;
  const config         = habemus.services.config;
  const hProject       = habemus.services.hProject;
  const hDev           = habemus.services.hDev;

  var headerElement = document.querySelector('#header');

  var authToken = hAccountDialog.getAuthToken();

  if (!authToken) {
    throw new Error('authToken is required');
  }

  Bluebird.all([
    hProject.getLatestVersion(authToken, config.cloud.projectCode, {
      byCode: true,
    }),
    hDev.get(authToken, config.cloud.projectCode, {
      byProjectCode: true
    })
  ])
  .then(function (results) {
    var projectLatestVersion = results[0];
    var workspace            = results[1];

    if (projectLatestVersion.code !== workspace.projectVersionCode) {
      headerElement.innerHTML = 
        'workspace is not at last version: project at ' +
        projectLatestVersion.code + ' and workspace at ' + 
        workspace.projectVersionCode + '. click here to update';

      headerElement.addEventListener('click', function (e) {
        e.preventDefault();

        hDev.loadLatestVersion(authToken, config.cloud.projectCode, {
          byProjectCode: true,
        });
      });
    } else {
      console.log('ok');
    }
  });

  return headerElement;
};
