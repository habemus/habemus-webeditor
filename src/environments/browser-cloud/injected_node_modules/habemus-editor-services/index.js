// third-party
const Bluebird = require('bluebird');

if (!process.env.H_ACCOUNT_URI) { throw new Error('H_ACCOUNT_URI env var MUST be set'); }
if (!process.env.H_PROJECT_URI) { throw new Error('H_PROJECT_URI env var MUST be set'); }
if (!process.env.H_WORKSPACE_URI) { throw new Error('H_WORKSPACE_URI env var MUST be set'); }
if (!process.env.UI_DASHBOARD_URI) { throw new Error('UI_DASHBOARD_URI env var MUST be set'); }

module.exports = function (habemus, options) {

  return Bluebird.resolve(
    require('./h-account-dialog')(habemus, options)
  )
  .then(function (hAccountDialog) {

    habemus.services.hAccountDialog = hAccountDialog;

    return Bluebird.resolve(require('./config')(habemus, options));
  })
  .then(function (config) {

    /**
     * Expose config
     * @type {Object}
     */
    habemus.services.config = config;

    return Bluebird.all([
      require('./h-dev')(habemus, options),
      require('./h-project')(habemus, options),
    ]);
  })
  .then(function (services) {

    /**
     * Expose required hDev
     * @type {Object}
     */
    habemus.services.hDev = services[0];

    /**
     * Expose browser-exclusive hProject
     * @type {Object}
     */
    habemus.services.hProject = services[1];
    
    
    // load workspace and projectLatestVersion
    return Bluebird.all([
      // retrieve workspace
      habemus.services.hDev.get(
        habemus.services.hAccountDialog.getAuthToken(),
        habemus.services.config.cloud.projectCode,
        {
          byProjectCode: true
        }
      ),
      // retrieve latest project version
      habemus.services.hProject.getLatestVersion(
        habemus.services.hAccountDialog.getAuthToken(),
        habemus.services.config.cloud.projectCode,
        {
          byCode: true
        }
      ),
    ])
    .then(function (results) {
      
      habemus.services.config.cloud.workspace = results[0];
      habemus.services.config.cloud.projectLatestVersion = results[1];
      
      return;
    });
  });

};
