// third-party
const Bluebird = require('bluebird');

module.exports = function (habemus, options) {

  if (navigator.serviceWorker.controller) {
    console.log('ServiceWorker worker already registered');

    return navigator.serviceWorker;
  } else {

    console.log('ServiceWorker not registered, start registration process');

    // sw registration (should be done only once)
    return navigator.serviceWorker.register('/service-worker.js', { scope: '/' })
      // Wait until the service worker is active.
      .then(function(registration) {
        console.log('ServiceWorker registration successful with scope: ', registration.scope);

        return navigator.serviceWorker;

        return navigator.serviceWorker.ready;
      })
      .then(function () {

        if (navigator.serviceWorker.controller) {
          console.log('The service worker is currently handling network operations.');

          return navigator.serviceWorker;
        } else {
          console.log('Please reload this page to allow the service worker to handle network operations.');

          habemus.services.dialogs.alert('Service worker registered successfully, but the browser MUST be refreshed. Will auto-refresh in 5 seconds.');

          return new Bluebird(function (resolve, reject) {
            setTimeout(function () {

              window.location.assign(window.location);

            }, 5000);
          });
        }
      })
      .catch(function(error) {
        // Something went wrong during registration. The service-worker.js file
        // might be unavailable or contain a syntax error.
        console.warn('sw error', error);

        habemus.services.dialogs.alert('An error happened registering the service worker! :(');
      });
  }

};
